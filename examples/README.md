# sl-archive-whondrs/examples
This directory contains scripts for using and visualizing the results 
of the machine learning workflow stored in this repository. Scripts
and notebooks are named after the figures that are in the manuscript.

# Provenance
The following are files in this directory that were not generated by
the ML workflow but are still used by the visualization. An explanation
of the source of each file is below.
+ `S19S_colocated_for_validation.csv` was copied from [global-river-databases](https://github.com/parallelworks/global-river-databases/blob/main/scripts/step_04_output.csv) and stored here for convenience. This file contains the data in RiverAtlas that correspond to this site to check that the colocation routines generate consistent results.
+ `RiverAtlas_GLORICH_colocated_for_prediction.csv` as copied from [global-river-databases](https://github.com/parallelworks/global-river-databases/blob/main/scripts/step_10_output.csv) and is stored here for convenience. This file contains all the colocated RiverAtlas and GLORICH data for making predictions.

# Making GMT plots
Some of the plots here are made with GMT delivered by a container.
The `fig_gmt_plot.sh` wrapper script will launch the container and then
execute whatever plotting script is specified in the container.  For example,
```
fig_gmt_plot.sh fig01_sites_map.sh
```
Will execute fig01_sites_map.sh in the container so it can use GMT inside the
container and the resulting plot will be stored as a PDF in this same directory.

# Selecting features for Summer-2019-log10-r10
The `table01_*` files used here were generated by running `fig04-05-06-ML-results.ipynb`.

## Top 20 features from Summer-2019-log10-r08
Used `awk -F, 'NR > 1 {print $3,$1}' table01_Summer-2019-log10-r08.csv | sort -g | awk '{print $2,$1}' | tail -20 >> README.md`

C_percent 1.1288407815008759

N_percent 1.1288407815008759

MiniDot_Sediment 1.1310193108171585

RA_ms_di 1.1319780218028372

Percent_Fine_Sand 1.161175278769132

perc_Carb 1.1629443025771706

GFE 1.1776896432873258

NOSC 1.1776896432873258

delGcox0PerCmol 1.1776896432873258

delGcoxPerCmol 1.1776896432873258

hft_ix_u09 1.1830955180747549

nli_ix_uav 1.1830955180747549

urb_pc_cse 1.1976612838970604

River_Gradient 1.2221388635308084

hft_ix_c09 1.2385602833517395

nli_ix_cav 1.2385602833517395

delGd 1.3078648473473924

delGd0 1.3078648473473924

lamO2 1.3078648473473924

lamO20 1.3078648473473924

## Top 20 features from Summer-2019-log10-r07
Used `awk -F, 'NR > 1 {print $3,$1}' table01_Summer-2019-log10-r07.csv | sort -g | awk '{print $2,$1}' | tail -20 >> README.md`

tmp_dc_uyr 1.0987124001569584

NPOC_Field_mg_per_L_as_C 1.1084677211337535

C_percent 1.1251914689802178

N_percent 1.1251914689802178

perc_Carb 1.1392660620660673

AI_Mod 1.1635255718335018

DBE 1.1635255718335018

GFE 1.1635255718335018

NOSC 1.1635255718335018

delGcox0PerCmol 1.1635255718335018

delGcoxPerCmol 1.1635255718335018

delGd 1.1635255718335018

delGd0 1.1635255718335018

lamO2 1.1635255718335018

lamO20 1.1635255718335018

perc_ConHC 1.1635255718335018

perc_Lignin 1.1635255718335018

perc_Lipid 1.1635255718335018

perc_Protein 1.1635255718335018

perc_Tannin 1.1635255718335018

## Merging notes

1. `C_percent`/`N_percent` are correlated and present in both. Choose `C_percent`.
2. Of the `perc_*` series, most are corrleated with each other and only `perc_Carb` is present in both.
3. `delG*`, `lamO2*` are correlated at high confidence, choose one: `lamO2`. For r07 (at lower R2), they
    are also correlated with the rest of the `perc_*` series that we are not including.
4. `NOSC` and `GFE` are always correlated and highly ranked, choose one: `NSOC`.
5. Let's train this ML model so it depends entirely on WHONDRS metadata + FTICR (features that
   are *only* available in the WHONDRS data and not in RiverAtlas - these are *local* data - 
   observations made in the field at the site/based on the actual collected sample) so that this model can
   be a counterpart to the ML models that use ONLY RiverAtlas "large-scale" *non-local* data. This approach means:
   + dropping `tmp_dc_uyr` (the lowest "large scale" feature in r07 top 20) and `RA_ms_di` (17th 
     "large-scale" feature in r08, which is probably represented by `River_Gradient`, 7th in r08, since
     that is an estimate of flow speed).
   + keeping `Minidot_Sediment` (1hot classifier) and `Percent_Fine_Sand` (real number from lab analysis)
   + dropping `hft_*`, `urb_*`, `nli_*` large-scale features (human footprint indicators) from r08.
   + NPOC_Field_mg_per_L_as_C is the remaining local feature in both r07 and r08.

## Merged top 8 features for Summer-2019-log10-r10

C_percent

perc_Carb

lamO2

NSOC

River_Gradient

MiniDot_Sediment

Percent_Fine_Sand

NPOC_Field_mg_per_L_as_C

